<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Watch Party</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #1a1a1a; color: white; height: 100vh; }
        .container { display: flex; flex-direction: column; height: 100vh; }
        header { background: #2d2d2d; padding: 1rem; border-bottom: 2px solid #444; }
        header h1 { margin-bottom: 0.5rem; color: #ff6b6b; }
        .room-controls { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; }
        .room-controls input { padding: 0.5rem; border: 1px solid #555; background: #333; color: white; border-radius: 4px; }
        .room-controls button { padding: 0.5rem 1rem; background: #ff6b6b; border: none; color: white; border-radius: 4px; cursor: pointer; }
        
        .main-content { display: flex; flex: 1; overflow: hidden; }
        .video-section { flex: 3; display: flex; flex-direction: column; padding: 1rem; }
        .video-controls { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
        .video-controls input { flex: 1; padding: 0.5rem; border: 1px solid #555; background: #333; color: white; border-radius: 4px; }
        .video-controls button { padding: 0.5rem 1rem; background: #4ecdc4; border: none; color: white; border-radius: 4px; cursor: pointer; }
        
        #videoPlayer { width: 100%; height: 400px; background: #000; margin-bottom: 1rem; border-radius: 8px; }
        .custom-player { width: 100%; height: 100%; border-radius: 8px; }
        
        .player-controls { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; }
        .player-controls button { padding: 0.5rem 1rem; background: #45b7d1; border: none; color: white; border-radius: 4px; cursor: pointer; }
        .time-display { font-family: monospace; }
        
        .chat-section { flex: 1; display: flex; flex-direction: column; background: #2d2d2d; border-left: 2px solid #444; min-width: 300px; }
        #messages { flex: 1; padding: 1rem; overflow-y: auto; display: flex; flex-direction: column; gap: 0.5rem; }
        .message { padding: 0.5rem; background: #333; border-radius: 4px; }
        .message .username { font-weight: bold; color: #ff6b6b; }
        .message .timestamp { font-size: 0.8rem; color: #888; }
        
        .message-input { display: flex; padding: 1rem; gap: 0.5rem; border-top: 1px solid #444; }
        .message-input input { flex: 1; padding: 0.5rem; border: 1px solid #555; background: #333; color: white; border-radius: 4px; }
        .message-input button { padding: 0.5rem 1rem; background: #ff6b6b; border: none; color: white; border-radius: 4px; cursor: pointer; }
        
        .video-info { margin-bottom: 1rem; padding: 0.5rem; background: #2d2d2d; border-radius: 4px; }
        .supported-sites { font-size: 0.8rem; color: #888; margin-top: 0.5rem; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üé¨ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π Video Watch Party</h1>
            <div class="room-controls">
                <input type="text" id="roomInput" placeholder="ID –∫–æ–º–Ω–∞—Ç—ã" value="room-1">
                <input type="text" id="usernameInput" placeholder="–í–∞—à–µ –∏–º—è" value="–ì–æ—Å—Ç—å">
                <button onclick="joinRoom()">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
            </div>
            <div class="supported-sites">
                –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: YouTube, RuTube, VK (–ø—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏), Dailymotion, Vimeo
            </div>
        </header>

        <div class="main-content">
            <div class="video-section">
                <div class="video-controls">
                    <input type="text" id="videoUrl" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ (YouTube, RuTube, VK –∏ –¥—Ä.)">
                    <button onclick="loadVideo()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ</button>
                </div>
                
                <div class="video-info" id="videoInfo">
                    –ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏–¥–µ–æ –ø–æ —Å—Å—ã–ª–∫–µ –≤—ã—à–µ
                </div>
                
                <div id="videoPlayer">
                    <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤–∏–¥–µ–æ -->
                    <div style="display: flex; justify-content: center; align-items: center; height: 100%; color: #666;">
                        –í–∏–¥–µ–æ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                    </div>
                </div>
                
                <div class="player-controls">
                    <button onclick="togglePlay()" id="playBtn">‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ</button>
                    <span class="time-display" id="timeDisplay">0:00 / 0:00</span>
                    <input type="range" id="progressBar" min="0" max="100" value="0" style="flex: 1;">
                    <button onclick="toggleFullscreen()">üì∫ –ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω</button>
                </div>
            </div>

            <div class="chat-section">
                <div id="messages"></div>
                <div class="message-input">
                    <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="handleKeyPress(event)">
                    <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket = null;
        let currentUsername = null;
        let currentVideo = null;
        let isPlaying = false;
        let currentTime = 0;
        let videoDuration = 0;
        let progressInterval = null;

        // –í–∏–¥–µ–æ–ø–ª–µ–µ—Ä —ç–ª–µ–º–µ–Ω—Ç—ã
        const videoPlayer = document.getElementById('videoPlayer');
        const progressBar = document.getElementById('progressBar');
        const timeDisplay = document.getElementById('timeDisplay');
        const playBtn = document.getElementById('playBtn');
        const videoInfo = document.getElementById('videoInfo');

        function joinRoom() {
            const roomId = document.getElementById('roomInput').value;
            const username = document.getElementById('usernameInput').value;
            
            if (!roomId || !username) {
                alert('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã –∏ –∏–º—è');
                return;
            }
            
            socket = io();
            currentUsername = username;
            
            socket.emit('join-room', roomId, username);
            setupSocketListeners();
            
            addMessage('–°–∏—Å—Ç–µ–º–∞', `–í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ "${roomId}"`, new Date().toLocaleTimeString());
        }

        function setupSocketListeners() {
            socket.on('room-state', (playerState, videoUrl) => {
                if (videoUrl) {
                    loadVideoFromUrl(videoUrl, false);
                }
                if (playerState) {
                    syncVideoState(playerState);
                }
            });
            
            socket.on('play', (time) => {
                playVideo();
                seekTo(time);
            });
            
            socket.on('pause', (time) => {
                pauseVideo();
                seekTo(time);
            });
            
            socket.on('seek', (time) => {
                seekTo(time);
            });
            
            socket.on('video-changed', (videoUrl) => {
                loadVideoFromUrl(videoUrl, false);
            });
            
            socket.on('new-message', (data) => {
                addMessage(data.username, data.message, data.timestamp);
            });
            
            socket.on('user-joined', (username) => {
                addMessage('–°–∏—Å—Ç–µ–º–∞', `${username} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ`, new Date().toLocaleTimeString());
            });
            
            socket.on('user-left', (username) => {
                addMessage('–°–∏—Å—Ç–µ–º–∞', `${username} –ø–æ–∫–∏–Ω—É–ª –∫–æ–º–Ω–∞—Ç—É`, new Date().toLocaleTimeString());
            });
        }

        function loadVideo() {
            const videoUrl = document.getElementById('videoUrl').value.trim();
            if (!videoUrl) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ');
                return;
            }
            
            if (socket) {
                socket.emit('change-video', videoUrl);
            }
            loadVideoFromUrl(videoUrl, true);
        }

        function loadVideoFromUrl(url, shouldEmit = true) {
            const videoId = extractVideoInfo(url);
            
            if (!videoId.embedUrl) {
                // –ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ —Ñ–∞–π–ª
                createNativeVideoPlayer(url, videoId.title);
            } else {
                // –í—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–µ –≤–∏–¥–µ–æ (YouTube, RuTube)
                createEmbeddedVideoPlayer(videoId.embedUrl, videoId.title);
            }
            
            videoInfo.innerHTML = `<strong>–°–µ–π—á–∞—Å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è:</strong> ${videoId.title || url}`;
            
            if (shouldEmit && socket) {
                socket.emit('video-changed', url);
            }
        }

        function extractVideoInfo(url) {
            // YouTube
            const youtubeRegex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
            const youtubeMatch = url.match(youtubeRegex);
            if (youtubeMatch) {
                return {
                    embedUrl: `https://www.youtube.com/embed/${youtubeMatch[1]}?enablejsapi=1`,
                    title: 'YouTube –≤–∏–¥–µ–æ'
                };
            }

            // RuTube
            const rutubeRegex = /rutube\.ru\/video\/([a-zA-Z0-9]+)/;
            const rutubeMatch = url.match(rutubeRegex);
            if (rutubeMatch) {
                return {
                    embedUrl: `https://rutube.ru/play/embed/${rutubeMatch[1]}`,
                    title: 'RuTube –≤–∏–¥–µ–æ'
                };
            }

            // Vimeo
            const vimeoRegex = /vimeo\.com\/([0-9]+)/;
            const vimeoMatch = url.match(vimeoRegex);
            if (vimeoMatch) {
                return {
                    embedUrl: `https://player.vimeo.com/video/${vimeoMatch[1]}`,
                    title: 'Vimeo –≤–∏–¥–µ–æ'
                };
            }

            // Dailymotion
            const dailymotionRegex = /dailymotion\.com\/video\/([a-zA-Z0-9]+)/;
            const dailymotionMatch = url.match(dailymotionRegex);
            if (dailymotionMatch) {
                return {
                    embedUrl: `https://www.dailymotion.com/embed/video/${dailymotionMatch[1]}`,
                    title: 'Dailymotion –≤–∏–¥–µ–æ'
                };
            }

            // –ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ —Ñ–∞–π–ª
            if (url.match(/\.(mp4|webm|ogg|mov|avi|mkv)(\?.*)?$/i)) {
                return {
                    embedUrl: null,
                    title: '–í–∏–¥–µ–æ —Ñ–∞–π–ª'
                };
            }

            return {
                embedUrl: null,
                title: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –≤–∏–¥–µ–æ'
            };
        }

        function createNativeVideoPlayer(videoUrl, title) {
            videoPlayer.innerHTML = `
                <video class="custom-player" id="nativeVideo" controls>
                    <source src="${videoUrl}" type="video/mp4">
                    –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ —Ç–µ–≥.
                </video>
            `;
            
            const video = document.getElementById('nativeVideo');
            currentVideo = video;
            
            video.addEventListener('play', () => {
                isPlaying = true;
                playBtn.textContent = '‚è∏Ô∏è –ü–∞—É–∑–∞';
                if (socket) socket.emit('play', video.currentTime);
            });
            
            video.addEventListener('pause', () => {
                isPlaying = false;
                playBtn.textContent = '‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ';
                if (socket) socket.emit('pause', video.currentTime);
            });
            
            video.addEventListener('seeked', () => {
                if (socket) socket.emit('seek', video.currentTime);
            });
            
            video.addEventListener('timeupdate', updateProgress);
            
            startProgressTracking();
        }

        function createEmbeddedVideoPlayer(embedUrl, title) {
            videoPlayer.innerHTML = `
                <iframe 
                    class="custom-player" 
                    id="embeddedVideo"
                    src="${embedUrl}"
                    frameborder="0" 
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                    allowfullscreen>
                </iframe>
            `;
            
            // –î–ª—è –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –≤–∏–¥–µ–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –±—É–¥–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π
            currentVideo = document.getElementById('embeddedVideo');
            videoInfo.innerHTML += '<br><small>‚ö†Ô∏è –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–ª—è —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ –≤–∏–¥–µ–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞</small>';
        }

        function playVideo() {
            if (currentVideo && currentVideo.tagName === 'VIDEO') {
                currentVideo.play();
                isPlaying = true;
                playBtn.textContent = '‚è∏Ô∏è –ü–∞—É–∑–∞';
            }
        }

        function pauseVideo() {
            if (currentVideo && currentVideo.tagName === 'VIDEO') {
                currentVideo.pause();
                isPlaying = false;
                playBtn.textContent = '‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ';
            }
        }

        function togglePlay() {
            if (!currentVideo) return;
            
            if (currentVideo.tagName === 'VIDEO') {
                if (isPlaying) {
                    pauseVideo();
                    if (socket) socket.emit('pause', currentVideo.currentTime);
                } else {
                    playVideo();
                    if (socket) socket.emit('play', currentVideo.currentTime);
                }
            }
        }

        function seekTo(time) {
            if (currentVideo && currentVideo.tagName === 'VIDEO') {
                currentVideo.currentTime = time;
                updateProgress();
            }
        }

        function updateProgress() {
            if (currentVideo && currentVideo.tagName === 'VIDEO') {
                const current = currentVideo.currentTime;
                const duration = currentVideo.duration || 0;
                
                currentTime = current;
                videoDuration = duration;
                
                const progress = duration > 0 ? (current / duration) * 100 : 0;
                progressBar.value = progress;
                
                const currentTimeStr = formatTime(current);
                const durationStr = formatTime(duration);
                timeDisplay.textContent = `${currentTimeStr} / ${durationStr}`;
            }
        }

        function formatTime(seconds) {
            if (!seconds || isNaN(seconds)) return '0:00';
            
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function startProgressTracking() {
            if (progressInterval) clearInterval(progressInterval);
            
            progressInterval = setInterval(() => {
                if (currentVideo && currentVideo.tagName === 'VIDEO' && isPlaying) {
                    updateProgress();
                }
            }, 1000);
        }

        progressBar.addEventListener('input', () => {
            if (currentVideo && currentVideo.tagName === 'VIDEO') {
                const seekTime = (progressBar.value / 100) * videoDuration;
                currentVideo.currentTime = seekTime;
                if (socket) socket.emit('seek', seekTime);
            }
        });

        function toggleFullscreen() {
            if (currentVideo) {
                if (currentVideo.requestFullscreen) {
                    currentVideo.requestFullscreen();
                } else if (currentVideo.webkitRequestFullscreen) {
                    currentVideo.webkitRequestFullscreen();
                } else if (currentVideo.mozRequestFullScreen) {
                    currentVideo.mozRequestFullScreen();
                }
            }
        }

        function syncVideoState(playerState) {
            if (playerState && currentVideo && currentVideo.tagName === 'VIDEO') {
                seekTo(playerState.currentTime);
                if (playerState.isPlaying) {
                    playVideo();
                } else {
                    pauseVideo();
                }
            }
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || !socket || !currentUsername) return;
            
            socket.emit('send-message', message, currentUsername);
            messageInput.value = '';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function addMessage(username, message, timestamp) {
            const messagesDiv = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            messageElement.innerHTML = `
                <div class="username">${username}</div>
                <div class="text">${message}</div>
                <div class="timestamp">${timestamp}</div>
            `;
            
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
        window.addEventListener('resize', () => {
            if (videoPlayer) {
                const height = Math.min(window.innerHeight * 0.6, 600);
                videoPlayer.style.height = height + 'px';
            }
        });
    </script>
</body>
</html>