<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Watch Party</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a; 
            color: white; 
            min-height: 100vh;
        }
        
        .container { 
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
        }
        
        /* Header */
        header {
            background: #2d2d2d;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #444;
        }
        
        header h1 {
            text-align: center;
            color: #ff6b6b;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }
        
        .room-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        @media (min-width: 768px) {
            .room-controls {
                flex-direction: row;
                align-items: center;
            }
        }
        
        .room-controls input {
            padding: 12px;
            border: 1px solid #555;
            background: #333;
            color: white;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .room-controls button {
            padding: 12px 20px;
            background: #ff6b6b;
            border: none;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .room-info {
            background: #333;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }
        
        .room-info.active {
            display: block;
        }
        
        .invite-link {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .invite-link input {
            flex: 1;
            padding: 10px;
            background: #444;
            border: 1px solid #555;
            color: white;
            border-radius: 6px;
        }
        
        .invite-link button {
            padding: 10px 15px;
            background: #4ecdc4;
            border: none;
            color: white;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .supported-sites {
            font-size: 0.8rem;
            color: #888;
            margin-top: 10px;
            text-align: center;
        }
        
        /* Main Content */
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        @media (min-width: 1024px) {
            .main-content {
                flex-direction: row;
            }
        }
        
        /* Video Section */
        .video-section {
            flex: 2;
            background: #2d2d2d;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #444;
        }
        
        .video-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        @media (min-width: 480px) {
            .video-controls {
                flex-direction: row;
            }
        }
        
        .video-controls input {
            flex: 1;
            padding: 12px;
            border: 1px solid #555;
            background: #333;
            color: white;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .video-controls button {
            padding: 12px 20px;
            background: #4ecdc4;
            border: none;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            white-space: nowrap;
        }
        
        #videoPlayer {
            width: 100%;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 15px;
            position: relative;
        }
        
        #videoPlayer::before {
            content: "";
            display: block;
            padding-top: 56.25%;
        }
        
        #videoPlayer iframe,
        #videoPlayer video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .video-info {
            background: #333;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }
        
        .player-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        
        .player-controls button {
            padding: 10px 15px;
            background: #45b7d1;
            border: none;
            color: white;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .time-display {
            font-family: monospace;
            font-size: 0.9rem;
            margin: 0 10px;
        }
        
        #progressBar {
            flex: 1;
            min-width: 100px;
        }
        
        /* Chat Section */
        .chat-section {
            flex: 1;
            background: #2d2d2d;
            border-radius: 10px;
            border: 1px solid #444;
            display: flex;
            flex-direction: column;
            min-height: 400px;
        }
        
        .users-list {
            padding: 15px;
            border-bottom: 1px solid #444;
        }
        
        .users-list h3 {
            color: #4ecdc4;
            margin-bottom: 10px;
        }
        
        #users {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .user-item {
            padding: 5px 10px;
            background: #333;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        #messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 300px;
        }
        
        .message {
            padding: 10px;
            background: #333;
            border-radius: 8px;
            word-wrap: break-word;
        }
        
        .message .username {
            font-weight: bold;
            color: #ff6b6b;
            font-size: 0.9rem;
        }
        
        .message .text {
            margin: 5px 0;
        }
        
        .message .timestamp {
            font-size: 0.7rem;
            color: #888;
        }
        
        .message-input {
            display: flex;
            padding: 15px;
            gap: 10px;
            border-top: 1px solid #444;
        }
        
        .message-input input {
            flex: 1;
            padding: 12px;
            border: 1px solid #555;
            background: #333;
            color: white;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .message-input button {
            padding: 12px 20px;
            background: #ff6b6b;
            border: none;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            white-space: nowrap;
        }
        
        /* –£–ª—É—á—à–µ–Ω–∏—è –¥–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            header {
                padding: 12px;
            }
            
            header h1 {
                font-size: 1.3rem;
            }
            
            .video-section,
            .chat-section {
                padding: 15px;
            }
            
            .player-controls {
                justify-content: center;
            }
            
            .player-controls button {
                flex: 1;
                min-width: 80px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üé¨ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π Video Watch Party</h1>
            <div class="room-controls">
                <input type="text" id="roomInput" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã" value="–∫–∏–Ω–æ-–≤–µ—á–µ—Ä">
                <input type="text" id="usernameInput" placeholder="–í–∞—à–µ –∏–º—è" value="–ì–æ—Å—Ç—å">
                <button onclick="joinRoom()">–°–æ–∑–¥–∞—Ç—å/–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
            </div>
            
            <div class="room-info" id="roomInfo">
                <div><strong>–ö–æ–º–Ω–∞—Ç–∞:</strong> <span id="currentRoomName">–∫–∏–Ω–æ-–≤–µ—á–µ—Ä</span></div>
                <div><strong>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</strong> <span id="usersCount">1</span></div>
                <div class="invite-link">
                    <input type="text" id="inviteUrl" readonly>
                    <button onclick="copyInviteLink()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
                </div>
            </div>
            
            <div class="supported-sites">
                –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: YouTube, RuTube, VK (–ø—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏), Dailymotion, Vimeo
            </div>
        </header>

        <div class="main-content">
            <div class="video-section">
                <div class="video-controls">
                    <input type="text" id="videoUrl" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ (YouTube, RuTube, VK –∏ –¥—Ä.)">
                    <button onclick="loadVideo()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ</button>
                </div>
                
                <div class="video-info" id="videoInfo">
                    –ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏–¥–µ–æ –ø–æ —Å—Å—ã–ª–∫–µ –≤—ã—à–µ
                </div>
                
                <div id="videoPlayer">
                    <div style="display: flex; justify-content: center; align-items: center; height: 100%; color: #666; flex-direction: column; gap: 10px;">
                        <div>üé¨</div>
                        <div>–í–∏–¥–µ–æ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏</div>
                    </div>
                </div>
                
                <div class="player-controls">
                    <button onclick="togglePlay()" id="playBtn">‚ñ∂Ô∏è –í–æ—Å–ø—Ä.</button>
                    <span class="time-display" id="timeDisplay">0:00 / 0:00</span>
                    <input type="range" id="progressBar" min="0" max="100" value="0" style="flex: 1;">
                    <button onclick="toggleFullscreen()">üì∫ –ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω</button>
                </div>
            </div>

            <div class="chat-section">
                <div class="users-list">
                    <h3>üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏ –∫–æ–º–Ω–∞—Ç—ã</h3>
                    <div id="users"></div>
                </div>
                <div id="messages"></div>
                <div class="message-input">
                    <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="handleKeyPress(event)">
                    <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket = null;
        let currentUsername = null;
        let currentRoom = null;
        let currentVideo = null;
        let isPlaying = false;
        let currentTime = 0;
        let videoDuration = 0;
        let progressInterval = null;

        const videoPlayer = document.getElementById('videoPlayer');
        const progressBar = document.getElementById('progressBar');
        const timeDisplay = document.getElementById('timeDisplay');
        const playBtn = document.getElementById('playBtn');
        const videoInfo = document.getElementById('videoInfo');
        const roomInfo = document.getElementById('roomInfo');
        const currentRoomName = document.getElementById('currentRoomName');
        const usersCount = document.getElementById('usersCount');
        const inviteUrl = document.getElementById('inviteUrl');
        const usersList = document.getElementById('users');

        function joinRoom() {
            const roomId = document.getElementById('roomInput').value;
            const username = document.getElementById('usernameInput').value;
            
            if (!roomId || !username) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã –∏ –≤–∞—à–µ –∏–º—è');
                return;
            }
            
            socket = io();
            currentUsername = username;
            currentRoom = roomId;
            
            socket.emit('join-room', roomId, username);
            setupSocketListeners();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–Ω–∞—Ç–µ
            roomInfo.classList.add('active');
            currentRoomName.textContent = roomId;
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
            const currentUrl = window.location.href.split('?')[0];
            inviteUrl.value = `${currentUrl}?room=${encodeURIComponent(roomId)}`;
            
            addMessage('–°–∏—Å—Ç–µ–º–∞', `–í—ã —Å–æ–∑–¥–∞–ª–∏ –∫–æ–º–Ω–∞—Ç—É "${roomId}"`, new Date().toLocaleTimeString());
            addMessage('–°–∏—Å—Ç–µ–º–∞', '–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –≤—ã—à–µ, —á—Ç–æ–±—ã –ø—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–∑–µ–π!', new Date().toLocaleTimeString());
        }

        function setupSocketListeners() {
            socket.on('room-state', (playerState, videoUrl) => {
                if (videoUrl) {
                    loadVideoFromUrl(videoUrl, false);
                }
                if (playerState) {
                    syncVideoState(playerState);
                }
            });
            
            socket.on('play', (time) => {
                playVideo();
                seekTo(time);
            });
            
            socket.on('pause', (time) => {
                pauseVideo();
                seekTo(time);
            });
            
            socket.on('seek', (time) => {
                seekTo(time);
            });
            
            socket.on('video-changed', (videoUrl) => {
                loadVideoFromUrl(videoUrl, false);
            });
            
            socket.on('new-message', (data) => {
                addMessage(data.username, data.message, data.timestamp);
            });
            
            socket.on('user-joined', (username) => {
                addMessage('–°–∏—Å—Ç–µ–º–∞', `${username} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ`, new Date().toLocaleTimeString());
            });
            
            socket.on('user-left', (username) => {
                addMessage('–°–∏—Å—Ç–µ–º–∞', `${username} –ø–æ–∫–∏–Ω—É–ª –∫–æ–º–Ω–∞—Ç—É`, new Date().toLocaleTimeString());
            });
            
            socket.on('user-list-update', (users) => {
                updateUsersList(users);
            });
        }

        function updateUsersList(users) {
            usersList.innerHTML = '';
            users.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = 'user-item';
                userElement.textContent = user;
                usersList.appendChild(userElement);
            });
            usersCount.textContent = users.length;
        }

        function copyInviteLink() {
            inviteUrl.select();
            document.execCommand('copy');
            alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞! –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ—ë –¥—Ä—É–∑—å—è–º.');
        }

        // –ê–≤—Ç–æ–ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ –∏–∑ URL
        function getRoomFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('room');
        }

        // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫–æ–º–Ω–∞—Ç–∞ –≤ URL
        window.addEventListener('load', function() {
            const roomFromUrl = getRoomFromUrl();
            if (roomFromUrl) {
                document.getElementById('roomInput').value = roomFromUrl;
            }
        });

        // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (loadVideo, playVideo, pauseVideo, addMessage –∏ —Ç.–¥.)
        // –æ—Å—Ç–∞—é—Ç—Å—è —Ç–∞–∫–∏–º–∏ –∂–µ, –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏
        // ... (–≤—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –æ—Å—Ç–∞–ª—å–Ω–æ–π JavaScript –∫–æ–¥ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏)

    </script>
</body>
</html>
