<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç - VideoWatchParty</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav class="navbar">
        <div class="logo">üé¨ VideoWatchParty</div>
        <div class="nav-links">
            <a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
            <a href="#" id="usernameDisplay"></a>
            <a href="#" id="logoutBtn" class="btn btn-secondary">–í—ã–π—Ç–∏</a>
        </div>
    </nav>

    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1>üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span id="userName"></span>!</h1>
            <p>–£–ø—Ä–∞–≤–ª—è–π—Ç–µ –≤–∞—à–∏–º–∏ –∫–æ–º–Ω–∞—Ç–∞–º–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏</p>
        </div>

        <div class="dashboard-grid">
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üé¨</div>
                    <div class="stat-info">
                        <h3 id="roomsCount">0</h3>
                        <p>–°–æ–∑–¥–∞–Ω–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-info">
                        <h3 id="totalUsers">0</h3>
                        <p>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤—Å–µ–≥–æ</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚è±Ô∏è</div>
                    <div class="stat-info">
                        <h3 id="watchTime">0—á</h3>
                        <p>–í—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</p>
                    </div>
                </div>
            </div>

            <!-- –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã -->
            <div class="card">
                <h2>üéØ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É</h2>
                <form id="createRoomForm" class="room-form">
                    <div class="form-group">
                        <label for="roomName">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã</label>
                        <input type="text" id="roomName" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–∏–Ω–æ–≤–µ—á–µ—Ä —Å –¥—Ä—É–∑—å—è–º–∏">
                    </div>
                    
                    <div class="form-group">
                        <label for="roomDescription">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea id="roomDescription" placeholder="–û —á—ë–º –±—É–¥–µ—Ç–µ —Å–º–æ—Ç—Ä–µ—Ç—å?"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="isPublic" checked>
                            <span class="checkmark"></span>
                            –ü—É–±–ª–∏—á–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞ (–≤–∏–¥–Ω–∞ –≤—Å–µ–º)
                        </label>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">üé¨ –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
                </form>
            </div>

            <!-- –ú–æ–∏ –∫–æ–º–Ω–∞—Ç—ã -->
            <div class="card">
                <h2>üì∫ –ú–æ–∏ –∫–æ–º–Ω–∞—Ç—ã</h2>
                <div id="myRoomsList" class="rooms-list">
                    <div class="empty-state">
                        <div>üé¨</div>
                        <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–Ω–∞—Ç</p>
                        <p class="text-muted">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∫–æ–º–Ω–∞—Ç—É –≤—ã—à–µ</p>
                    </div>
                </div>
            </div>

            <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã -->
            <div class="card">
                <h2>üî• –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã</h2>
                <div id="activeRoomsList" class="rooms-list">
                    <div class="empty-state">
                        <div>‚è≥</div>
                        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–Ω–∞—Ç...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const usernameDisplay = document.getElementById('usernameDisplay');
        const userName = document.getElementById('userName');
        const logoutBtn = document.getElementById('logoutBtn');
        const createRoomForm = document.getElementById('createRoomForm');
        const myRoomsList = document.getElementById('myRoomsList');
        const activeRoomsList = document.getElementById('activeRoomsList');
        const roomsCount = document.getElementById('roomsCount');
        const totalUsers = document.getElementById('totalUsers');
        const watchTime = document.getElementById('watchTime');

        let currentUser = null;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function checkAuth() {
            const token = localStorage.getItem('token');
            const userData = localStorage.getItem('user');
            
            if (!token || !userData) {
                window.location.href = 'login.html';
                return;
            }
            
            try {
                currentUser = JSON.parse(userData);
                usernameDisplay.textContent = currentUser.username;
                userName.textContent = currentUser.username;
            } catch (error) {
                window.location.href = 'login.html';
            }
        }

        // –í—ã—Ö–æ–¥
        logoutBtn.addEventListener('click', function() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        });

        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
        createRoomForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const roomName = document.getElementById('roomName').value;
            const roomDescription = document.getElementById('roomDescription').value;
            const isPublic = document.getElementById('isPublic').checked;
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/rooms/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        name: roomName,
                        description: roomDescription,
                        isPublic: isPublic
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('–ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞!');
                    createRoomForm.reset();
                    loadMyRooms();
                    loadActiveRooms();
                } else {
                    alert(data.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã');
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            }
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–∏—Ö –∫–æ–º–Ω–∞—Ç
        async function loadMyRooms() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/rooms/my', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const rooms = await response.json();
                
                if (rooms.length === 0) {
                    myRoomsList.innerHTML = `
                        <div class="empty-state">
                            <div>üé¨</div>
                            <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–Ω–∞—Ç</p>
                            <p class="text-muted">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∫–æ–º–Ω–∞—Ç—É –≤—ã—à–µ</p>
                        </div>
                    `;
                    return;
                }
                
                myRoomsList.innerHTML = rooms.map(room => `
                    <div class="room-item">
                        <div class="room-info">
                            <h4>${room.name}</h4>
                            <p class="text-muted">${room.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                            <div class="room-meta">
                                <span>üë• ${room.users.length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</span>
                                <span>${new Date(room.createdAt).toLocaleDateString()}</span>
                            </div>
                        </div>
                        <div class="room-actions">
                            <a href="room.html?room=${room._id}" class="btn btn-primary btn-small">
                                –û—Ç–∫—Ä—ã—Ç—å
                            </a>
                        </div>
                    </div>
                `).join('');
                
                roomsCount.textContent = rooms.length;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–Ω–∞—Ç:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç
        async function loadActiveRooms() {
            try {
                const response = await fetch('/api/rooms/active');
                const rooms = await response.json();
                
                if (rooms.length === 0) {
                    activeRoomsList.innerHTML = `
                        <div class="empty-state">
                            <div>üò¥</div>
                            <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç</p>
                            <p class="text-muted">–ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º, –∫—Ç–æ —Å–æ–∑–¥–∞—Å—Ç –∫–æ–º–Ω–∞—Ç—É!</p>
                        </div>
                    `;
                    return;
                }
                
                activeRoomsList.innerHTML = rooms.map(room => `
                    <div class="room-item">
                        <div class="room-info">
                            <h4>${room.name}</h4>
                            <p class="text-muted">${room.description || '–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –ø—Ä–æ—Å–º–æ—Ç—Ä—É!'}</p>
                            <div class="room-meta">
                                <span>üë• ${room.users.length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</span>
                                <span>–°–æ–∑–¥–∞–ª: ${room.owner?.username || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</span>
                            </div>
                        </div>
                        <div class="room-actions">
                            <a href="room.html?room=${room._id}" class="btn btn-primary btn-small">
                                –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
                            </a>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        async function loadStats() {
            // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            totalUsers.textContent = '12';
            watchTime.textContent = '5—á';
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.addEventListener('load', function() {
            checkAuth();
            loadMyRooms();
            loadActiveRooms();
            loadStats();
        });
    </script>
</body>
</html>
