<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–º–Ω–∞—Ç–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ - VideoWatchParty</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .room-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .video-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .video-player-container {
            background: rgba(45, 45, 45, 0.8);
            border-radius: 15px;
            padding: 1rem;
            border: 1px solid #444;
        }
        
        #videoPlayer {
            width: 100%;
            height: 400px;
            border-radius: 10px;
            background: #000;
        }
        
        .video-iframe {
            width: 100%;
            height: 400px;
            border-radius: 10px;
            border: none;
        }
        
        .video-controls {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            justify-content: center;
        }
        
        .video-controls.hidden {
            display: none;
        }
        
        .video-url-input {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .video-url-input input {
            flex: 1;
            padding: 0.8rem;
            border: 1px solid #555;
            background: #333;
            color: white;
            border-radius: 8px;
        }
        
        .supported-platforms {
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: #888;
            text-align: center;
        }
        
        .platform-notice {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid #ff6b6b;
            border-radius: 8px;
            text-align: center;
            color: #ff6b6b;
        }
        
        .sync-notice {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid #4caf50;
            border-radius: 8px;
            text-align: center;
            color: #4caf50;
        }
        
        .current-video-info {
            margin-top: 1rem;
            padding: 0.8rem;
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid #4caf50;
            border-radius: 8px;
            text-align: center;
            color: #4caf50;
        }
        
        .chat-container {
            background: rgba(45, 45, 45, 0.8);
            border-radius: 15px;
            padding: 1.5rem;
            border: 1px solid #444;
            display: flex;
            flex-direction: column;
            height: 500px;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 1rem;
            padding-right: 0.5rem;
        }
        
        .chat-message {
            margin-bottom: 1rem;
            padding: 0.8rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }
        
        .message-sender {
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 0.3rem;
        }
        
        .chat-input {
            display: flex;
            gap: 0.5rem;
        }
        
        .chat-input input {
            flex: 1;
            padding: 0.8rem;
            border: 1px solid #555;
            background: #333;
            color: white;
            border-radius: 8px;
        }
        
        .room-info {
            background: rgba(45, 45, 45, 0.8);
            border-radius: 15px;
            padding: 1.5rem;
            border: 1px solid #444;
            margin-bottom: 2rem;
        }
        
        .room-users {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        .user-badge {
            background: rgba(255, 107, 107, 0.2);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            border: 1px solid #ff6b6b;
        }
        
        @media (max-width: 768px) {
            .video-section {
                grid-template-columns: 1fr;
            }
            
            #videoPlayer, .video-iframe {
                height: 300px;
            }
            
            .chat-container {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo">üé¨ VideoWatchParty</div>
        <div class="nav-links">
            <a href="/">–ì–ª–∞–≤–Ω–∞—è</a>
            <a href="/dashboard">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a>
            <a href="#" id="usernameDisplay">–ì–æ—Å—Ç—å</a>
            <a href="#" onclick="logout()" class="btn btn-secondary">–í—ã–π—Ç–∏</a>
        </div>
    </nav>

    <div class="room-container">
        <div class="room-info">
            <h1 id="roomTitle">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–Ω–∞—Ç—ã...</h1>
            <p id="roomDescription"></p>
            <div class="room-users" id="roomUsers">
                <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
            </div>
        </div>

        <div class="video-section">
            <div class="video-player-container">
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–∫—É—â–µ–º –≤–∏–¥–µ–æ -->
                <div id="currentVideoInfo" class="current-video-info" style="display: none;">
                    üìπ –¢–µ–∫—É—â–µ–µ –≤–∏–¥–µ–æ: <span id="currentVideoUrl"></span>
                </div>
                
                <video id="videoPlayer" controls>
                    <!-- –í–∏–¥–µ–æ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ —á–µ—Ä–µ–∑ JS -->
                    –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ —Ç–µ–≥.
                </video>
                
                <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è iframe (YouTube, VK, Rutube) -->
                <div id="videoIframeContainer"></div>
                
                <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ -->
                <div id="platformNotice" class="platform-notice" style="display: none;">
                    ‚ö†Ô∏è –î–ª—è YouTube/VK/Rutube —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –∏–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø–ª–∞—Ç—Ñ–æ—Ä–º.<br>
                    –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–ª–µ–µ—Ä–∞ –∏ –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–π—Ç–µ –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ —á–∞—Ç.
                </div>
                
                <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ -->
                <div id="syncNotice" class="sync-notice" style="display: none;">
                    ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–∞ –¥–ª—è MP4 –≤–∏–¥–µ–æ
                </div>
                
                <!-- –ü–æ–ª–µ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ –≤–∏–¥–µ–æ -->
                <div class="video-url-input">
                    <input type="text" id="videoUrlInput" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ (YouTube, VK, Rutube, MP4)">
                    <button id="loadVideoBtn" class="btn btn-primary">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                </div>
                
                <div class="supported-platforms">
                    üìπ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: YouTube, VK Video, Rutube, –ø—Ä—è–º—ã–µ MP4 —Å—Å—ã–ª–∫–∏
                </div>
                
                <div class="video-controls" id="videoControls">
                    <input type="range" id="seekBar" min="0" max="100" value="0" style="flex: 1;">
                    <button id="playBtn" class="btn btn-primary">‚ñ∂Ô∏è –í–æ—Å–ø—Ä.</button>
                    <button id="pauseBtn" class="btn btn-secondary">‚è∏Ô∏è –ü–∞—É–∑–∞</button>
                    <button id="syncBtn" class="btn btn-secondary">üîÑ –°–∏–Ω—Ö—Ä.</button>
                </div>
            </div>

            <div class="chat-container">
                <h3>üí¨ –ß–∞—Ç –∫–æ–º–Ω–∞—Ç—ã</h3>
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-message">
                        <div class="message-sender">–°–∏—Å—Ç–µ–º–∞</div>
                        <div>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∫–æ–º–Ω–∞—Ç—É! –û–∂–∏–¥–∞–π—Ç–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Å–≤–æ—é —Å—Å—ã–ª–∫—É</div>
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="chatInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                    <button id="sendBtn" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>üîó –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–∑–µ–π</h2>
            <p>–û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É –¥—Ä—É–∑—å—è–º, —á—Ç–æ–±—ã –æ–Ω–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –ø—Ä–æ—Å–º–æ—Ç—Ä—É:</p>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <input type="text" id="inviteLink" readonly style="flex: 1; padding: 0.8rem; background: #333; border: 1px solid #555; border-radius: 8px; color: white;">
                <button id="copyInviteBtn" class="btn btn-primary">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // –ü–æ–ª—É—á–∞–µ–º ID –∫–æ–º–Ω–∞—Ç—ã –∏–∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room') || 'default-room';
        
        let socket = null;
        let currentUser = JSON.parse(localStorage.getItem('user') || 'null');
        let currentVideoType = '';
        let currentVideoUrl = '';
        let isSyncingEnabled = true;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            initializeRoom();
            updateUserNavigation();
        });

        function initializeRoom() {
            // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ
            socket = io();
            
            // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ –∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤–∏–¥–µ–æ
            socket.emit('join-room', roomId);
            socket.emit('request-current-video', { roomId: roomId });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            updateRoomUI();
            initializeVideoPlayer();
            initializeChat();
            initializeInviteLink();
            initializeVideoUrlInput();
        }

        function updateUserNavigation() {
            const usernameDisplay = document.getElementById('usernameDisplay');
            if (currentUser && usernameDisplay) {
                usernameDisplay.textContent = currentUser.username;
            }
        }

        function updateRoomUI() {
            document.getElementById('roomTitle').textContent = `–ö–æ–º–Ω–∞—Ç–∞: ${roomId}`;
            document.getElementById('inviteLink').value = window.location.href;
        }

        function initializeVideoUrlInput() {
            const videoUrlInput = document.getElementById('videoUrlInput');
            const loadVideoBtn = document.getElementById('loadVideoBtn');
            
            loadVideoBtn.addEventListener('click', loadVideoFromUrl);
            videoUrlInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    loadVideoFromUrl();
                }
            });
        }

        function loadVideoFromUrl() {
            const videoUrl = document.getElementById('videoUrlInput').value.trim();
            if (videoUrl) {
                loadVideo(videoUrl, true); // true = broadcast to others
            }
        }

        function loadVideo(videoUrl, broadcast = false) {
            const videoPlayer = document.getElementById('videoPlayer');
            const iframeContainer = document.getElementById('videoIframeContainer');
            const videoControls = document.getElementById('videoControls');
            const platformNotice = document.getElementById('platformNotice');
            const syncNotice = document.getElementById('syncNotice');
            const currentVideoInfo = document.getElementById('currentVideoInfo');
            const currentVideoUrlSpan = document.getElementById('currentVideoUrl');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –≤–∏–¥–µ–æ
            currentVideoUrl = videoUrl;
            document.getElementById('videoUrlInput').value = videoUrl;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –≤–∏–¥–µ–æ
            currentVideoUrlSpan.textContent = videoUrl;
            currentVideoInfo.style.display = 'block';
            
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏
            videoPlayer.innerHTML = '';
            iframeContainer.innerHTML = '';
            
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –ø–ª–µ–µ—Ä—ã –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            videoPlayer.style.display = 'none';
            platformNotice.style.display = 'none';
            syncNotice.style.display = 'none';
            videoControls.classList.remove('hidden');
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –≤–∏–¥–µ–æ –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º
            if (videoUrl.includes('youtube.com') || videoUrl.includes('youtu.be')) {
                loadYouTubeVideo(videoUrl);
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—ã –¥–ª—è YouTube –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                videoControls.classList.add('hidden');
                platformNotice.style.display = 'block';
                isSyncingEnabled = false;
            } else if (videoUrl.includes('vk.com') || videoUrl.includes('vk.ru')) {
                loadVKVideo(videoUrl);
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—ã –¥–ª—è VK –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                videoControls.classList.add('hidden');
                platformNotice.style.display = 'block';
                isSyncingEnabled = false;
            } else if (videoUrl.includes('rutube.ru')) {
                loadRutubeVideo(videoUrl);
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—ã –¥–ª—è Rutube –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                videoControls.classList.add('hidden');
                platformNotice.style.display = 'block';
                isSyncingEnabled = false;
            } else if (videoUrl.endsWith('.mp4') || videoUrl.includes('mp4')) {
                loadMP4Video(videoUrl);
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—ã –¥–ª—è MP4 –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                videoControls.classList.remove('hidden');
                syncNotice.style.display = 'block';
                isSyncingEnabled = true;
            } else {
                alert('–ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç –≤–∏–¥–µ–æ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: YouTube, VK, Rutube –∏–ª–∏ –ø—Ä—è–º—ã–µ MP4 —Å—Å—ã–ª–∫–∏');
                return;
            }
            
            // –°–æ–æ–±—â–∞–µ–º –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –æ —Å–º–µ–Ω–µ –≤–∏–¥–µ–æ
            if (broadcast) {
                socket.emit('video-changed', {
                    roomId: roomId,
                    videoUrl: videoUrl,
                    videoType: currentVideoType
                });
                
                addSystemMessage(`–í—ã –∑–∞–≥—Ä—É–∑–∏–ª–∏ –Ω–æ–≤–æ–µ –≤–∏–¥–µ–æ (${currentVideoType})`);
            } else {
                addSystemMessage(`–í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ (${currentVideoType})`);
            }
        }

        function loadYouTubeVideo(url) {
            currentVideoType = 'YouTube';
            const youtubeId = extractYouTubeId(url);
            if (youtubeId) {
                const iframeContainer = document.getElementById('videoIframeContainer');
                const iframe = document.createElement('iframe');
                iframe.className = 'video-iframe';
                iframe.src = `https://www.youtube.com/embed/${youtubeId}?enablejsapi=1`;
                iframe.frameBorder = '0';
                iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
                iframe.allowFullscreen = true;
                iframeContainer.appendChild(iframe);
            }
        }

        function loadVKVideo(url) {
            currentVideoType = 'VK Video';
            const vkVideoId = extractVKVideoId(url);
            if (vkVideoId) {
                const iframeContainer = document.getElementById('videoIframeContainer');
                const iframe = document.createElement('iframe');
                iframe.className = 'video-iframe';
                iframe.src = `https://vk.com/video_ext.php?oid=${vkVideoId.ownerId}&id=${vkVideoId.videoId}&hash=${vkVideoId.hash}`;
                iframe.frameBorder = '0';
                iframe.allowFullscreen = true;
                iframeContainer.appendChild(iframe);
            }
        }

        function loadRutubeVideo(url) {
            currentVideoType = 'Rutube';
            const rutubeId = extractRutubeId(url);
            if (rutubeId) {
                const iframeContainer = document.getElementById('videoIframeContainer');
                const iframe = document.createElement('iframe');
                iframe.className = 'video-iframe';
                iframe.src = `https://rutube.ru/play/embed/${rutubeId}`;
                iframe.frameBorder = '0';
                iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
                iframe.allowFullscreen = true;
                iframeContainer.appendChild(iframe);
            }
        }

        function loadMP4Video(url) {
            currentVideoType = 'MP4';
            const videoPlayer = document.getElementById('videoPlayer');
            videoPlayer.innerHTML = `
                <source src="${url}" type="video/mp4">
                –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ —Ç–µ–≥.
            `;
            videoPlayer.style.display = 'block';
            videoPlayer.load();
        }

        function extractYouTubeId(url) {
            const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[7].length === 11) ? match[7] : false;
        }

        function extractVKVideoId(url) {
            const regExp = /video(?:-)?(\d+)_(\d+)/;
            const match = url.match(regExp);
            if (match && match[1] && match[2]) {
                return {
                    ownerId: match[1],
                    videoId: match[2],
                    hash: ''
                };
            }
            return false;
        }

        function extractRutubeId(url) {
            const regExp = /rutube\.ru\/(?:video|play\/embed)\/([a-zA-Z0-9]+)/;
            const match = url.match(regExp);
            return (match && match[1]) ? match[1] : false;
        }

        function initializeVideoPlayer() {
            const videoPlayer = document.getElementById('videoPlayer');
            const playBtn = document.getElementById('playBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            const seekBar = document.getElementById('seekBar');
            const syncBtn = document.getElementById('syncBtn');

            // –°–æ–±—ã—Ç–∏—è –≤–∏–¥–µ–æ (—Ç–æ–ª—å–∫–æ –¥–ª—è MP4)
            videoPlayer.addEventListener('play', () => {
                if (currentVideoType === 'MP4' && isSyncingEnabled) {
                    socket.emit('play-video', {
                        roomId: roomId,
                        timestamp: videoPlayer.currentTime
                    });
                }
            });

            videoPlayer.addEventListener('pause', () => {
                if (currentVideoType === 'MP4' && isSyncingEnabled) {
                    socket.emit('pause-video', {
                        roomId: roomId,
                        timestamp: videoPlayer.currentTime
                    });
                }
            });

            videoPlayer.addEventListener('seeked', () => {
                if (currentVideoType === 'MP4' && isSyncingEnabled) {
                    socket.emit('seek-video', {
                        roomId: roomId,
                        timestamp: videoPlayer.currentTime
                    });
                }
            });

            // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è MP4)
            playBtn.addEventListener('click', () => {
                if (currentVideoType === 'MP4') {
                    videoPlayer.play();
                }
            });

            pauseBtn.addEventListener('click', () => {
                if (currentVideoType === 'MP4') {
                    videoPlayer.pause();
                }
            });

            // –ö–Ω–æ–ø–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
            syncBtn.addEventListener('click', () => {
                if (currentVideoType === 'MP4') {
                    socket.emit('sync-video', {
                        roomId: roomId,
                        timestamp: videoPlayer.currentTime,
                        action: 'sync'
                    });
                    addSystemMessage('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é');
                }
            });

            // –ü–æ–ª–∑—É–Ω–æ–∫ (—Ç–æ–ª—å–∫–æ –¥–ª—è MP4)
            videoPlayer.addEventListener('timeupdate', () => {
                if (currentVideoType === 'MP4' && videoPlayer.duration) {
                    seekBar.value = (videoPlayer.currentTime / videoPlayer.duration) * 100;
                }
            });

            seekBar.addEventListener('input', () => {
                if (currentVideoType === 'MP4' && videoPlayer.duration) {
                    videoPlayer.currentTime = (seekBar.value / 100) * videoPlayer.duration;
                }
            });

            // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏—è –æ—Ç –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Ç–æ–ª—å–∫–æ –¥–ª—è MP4)
            socket.on('video-play', (data) => {
                if (currentVideoType === 'MP4' && isSyncingEnabled) {
                    if (Math.abs(videoPlayer.currentTime - data.timestamp) > 2) {
                        videoPlayer.currentTime = data.timestamp;
                    }
                    videoPlayer.play();
                    addSystemMessage('–í–∏–¥–µ–æ –∑–∞–ø—É—â–µ–Ω–æ –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º');
                }
            });

            socket.on('video-pause', (data) => {
                if (currentVideoType === 'MP4' && isSyncingEnabled) {
                    if (Math.abs(videoPlayer.currentTime - data.timestamp) > 2) {
                        videoPlayer.currentTime = data.timestamp;
                    }
                    videoPlayer.pause();
                    addSystemMessage('–í–∏–¥–µ–æ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º');
                }
            });

            socket.on('video-seek', (data) => {
                if (currentVideoType === 'MP4' && isSyncingEnabled) {
                    if (Math.abs(videoPlayer.currentTime - data.timestamp) > 2) {
                        videoPlayer.currentTime = data.timestamp;
                    }
                }
            });

            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ –∑–∞–ø—Ä–æ—Å—É
            socket.on('sync-video', (data) => {
                if (currentVideoType === 'MP4') {
                    videoPlayer.currentTime = data.timestamp;
                    addSystemMessage('–í–∏–¥–µ–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É');
                }
            });

            // –°–ª—É—à–∞–µ–º —Å–º–µ–Ω—É –≤–∏–¥–µ–æ –æ—Ç –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            socket.on('video-changed', (data) => {
                loadVideo(data.videoUrl, false); // false = don't broadcast
                addSystemMessage(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∑–∏–ª –Ω–æ–≤–æ–µ –≤–∏–¥–µ–æ (${data.videoType})`);
            });

            // –ó–∞–ø—Ä–æ—Å —Ç–µ–∫—É—â–µ–≥–æ –≤–∏–¥–µ–æ
            socket.on('current-video', (data) => {
                if (data.videoUrl && !currentVideoUrl) {
                    loadVideo(data.videoUrl, false);
                    addSystemMessage('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Ç–µ–∫—É—â–µ–µ –≤–∏–¥–µ–æ –∫–æ–º–Ω–∞—Ç—ã');
                }
            });

            socket.on('user-joined', (userId) => {
                addSystemMessage(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ`);
                
                // –ï—Å–ª–∏ —É –Ω–∞—Å –µ—Å—Ç—å –≤–∏–¥–µ–æ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ–≥–æ –Ω–æ–≤–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                if (currentVideoUrl) {
                    socket.emit('video-changed', {
                        roomId: roomId,
                        videoUrl: currentVideoUrl,
                        videoType: currentVideoType
                    });
                }
            });
        }

        function initializeChat() {
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            const chatMessages = document.getElementById('chatMessages');

            sendBtn.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // –°–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            socket.on('chat-message', (data) => {
                addChatMessage(data.username, data.message);
            });
        }

        function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (message && currentUser) {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                socket.emit('chat-message', {
                    roomId: roomId,
                    username: currentUser.username,
                    message: message
                });
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                addChatMessage(currentUser.username, message);
                chatInput.value = '';
            }
        }

        function addChatMessage(username, message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message';
            messageDiv.innerHTML = `
                <div class="message-sender">${username}</div>
                <div>${message}</div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addSystemMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message';
            messageDiv.innerHTML = `
                <div class="message-sender" style="color: #4ecdc4;">–°–∏—Å—Ç–µ–º–∞</div>
                <div>${message}</div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function initializeInviteLink() {
            const copyBtn = document.getElementById('copyInviteBtn');
            copyBtn.addEventListener('click', () => {
                const inviteLink = document.getElementById('inviteLink');
                inviteLink.select();
                document.execCommand('copy');
                alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
            });
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/';
        }
    </script>
</body>
</html>
